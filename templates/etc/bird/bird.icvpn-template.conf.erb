# this is file is generated by puppet

filter icvpn_import_filter {
  if is_dn42() then accept;
  if roa_check(icvpn_roa) = ROA_VALID then {
    accept;
  } else {
    print "ROA check failed for ", net, " ASN ", bgp_path.last;
  }
  reject;
}

# template for icvpn route exchange via bgp
# we exchange freifunk and dn42 routes with peers
# chaosvpn should not be exchanged because chaosvpn misses a route to not
# directly connected communities in the usual setup
template bgp icvpn {
  table mesh;
  local as <%= @icvpn_as %>;
  source address <%= @icvpn_ipv4_address %>;
  import filter icvpn_import_filter;
  export where ((source = RTS_BGP) || (source = RTS_STATIC)) && (is_freifunk() || is_dn42()) && !is_default() && !is_chaos();
};
